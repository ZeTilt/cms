class PushNotifications{constructor(r){this.vapidPublicKey=r,this.registration=null,this.subscription=null}async init(){if(!("serviceWorker"in navigator)||!("PushManager"in window))return console.warn("Push notifications not supported"),!1;try{return this.registration=await Promise.race([navigator.serviceWorker.ready,new Promise((r,s)=>setTimeout(()=>s(new Error("Service worker timeout")),1e4))]),console.log("Service worker ready for push notifications"),this.subscription=await this.registration.pushManager.getSubscription(),!0}catch(r){console.error("Error initializing push notifications:",r);const s=await navigator.serviceWorker.getRegistration();return!!s&&(console.log("Found existing service worker registration"),this.registration=s,this.subscription=await this.registration.pushManager.getSubscription(),!0)}}async isSubscribed(){if(!this.registration){if(!await this.init()||!this.registration)return console.warn("Service worker not available"),!1}try{return this.subscription=await this.registration.pushManager.getSubscription(),null!==this.subscription}catch(r){return console.error("Error checking subscription:",r),!1}}async subscribe(r={}){try{if("granted"!==await Notification.requestPermission())return console.log("Notification permission denied"),{success:!1,reason:"permission_denied"};const s=await this.registration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(this.vapidPublicKey)}),e=await fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({endpoint:s.endpoint,keys:{p256dh:this.arrayBufferToBase64(s.getKey("p256dh")),auth:this.arrayBufferToBase64(s.getKey("auth"))},preferences:r})}),i=await e.json();return e.ok?(this.subscription=s,console.log("Successfully subscribed to push notifications"),{success:!0,data:i}):(console.error("Failed to save subscription on server:",i),{success:!1,reason:"server_error",error:i})}catch(r){return console.error("Error subscribing to push notifications:",r),{success:!1,reason:"error",error:r.message}}}async unsubscribe(){try{if(this.subscription||(this.subscription=await this.registration.pushManager.getSubscription()),!this.subscription)return console.log("No subscription to unsubscribe from"),{success:!0};await this.subscription.unsubscribe();const r=await fetch("/api/push/unsubscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({endpoint:this.subscription.endpoint})}),s=await r.json();return r.ok?(this.subscription=null,console.log("Successfully unsubscribed from push notifications"),{success:!0,data:s}):(console.error("Failed to unsubscribe on server:",s),{success:!1,reason:"server_error",error:s})}catch(r){return console.error("Error unsubscribing from push notifications:",r),{success:!1,reason:"error",error:r.message}}}async updatePreferences(r){try{if(this.subscription||(this.subscription=await this.registration.pushManager.getSubscription()),!this.subscription)return{success:!1,reason:"not_subscribed"};const s=await fetch("/api/push/preferences",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({endpoint:this.subscription.endpoint,preferences:r})}),e=await s.json();return s.ok?(console.log("Preferences updated successfully"),{success:!0,data:e}):(console.error("Failed to update preferences:",e),{success:!1,reason:"server_error",error:e})}catch(r){return console.error("Error updating preferences:",r),{success:!1,reason:"error",error:r.message}}}urlBase64ToUint8Array(r){const s=(r+"=".repeat((4-r.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),e=window.atob(s),i=new Uint8Array(e.length);for(let r=0;r<e.length;++r)i[r]=e.charCodeAt(r);return i}arrayBufferToBase64(r){const s=new Uint8Array(r);let e="";for(let r=0;r<s.byteLength;r++)e+=String.fromCharCode(s[r]);return window.btoa(e)}}window.PushNotifications=PushNotifications;