{% extends 'admin/base.html.twig' %}

{% block page_title %}Modifier le menu : {{ menu.name }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-6">
        <a href="{{ path('admin_menus_index') }}" class="text-gray-600 hover:text-gray-800">
            ‚Üê Retour aux menus
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Liste des √©l√©ments -->
        <div class="lg:col-span-2">
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">{{ menu.name }}</h3>
                        <p class="text-sm text-gray-500">Identifiant: <code class="bg-gray-100 px-1 rounded">{{ menu.location }}</code></p>
                    </div>
                </div>

                <div class="p-6">
                    {% set rootItems = menu.rootItems %}
                    {% if rootItems is empty %}
                        <div class="text-center py-8 text-gray-500">
                            <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                            </svg>
                            <p>Aucun √©l√©ment dans ce menu</p>
                            <p class="text-sm">Utilisez le formulaire √† droite pour ajouter des √©l√©ments.</p>
                        </div>
                    {% else %}
                        <ul class="space-y-2" id="menu-items">
                            {% for item in rootItems|filter(i => i.active) %}
                                {{ _self.render_menu_item(item) }}
                            {% endfor %}
                            {% for item in rootItems|filter(i => not i.active) %}
                                {{ _self.render_menu_item(item) }}
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Formulaire d'ajout -->
        <div>
            <div class="bg-white shadow rounded-lg">
                <div class="px-4 py-3 border-b border-gray-200">
                    <h4 class="font-medium text-gray-900">Ajouter un √©l√©ment</h4>
                </div>

                <form action="{{ path('admin_menus_items_add', {id: menu.id}) }}" method="POST" class="p-4 space-y-4">
                    <div>
                        <label for="label" class="block text-sm font-medium text-gray-700 mb-1">
                            Libell√© *
                        </label>
                        <input type="text"
                               id="label"
                               name="label"
                               required
                               placeholder="Ex: Qui sommes-nous"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-club-orange focus:border-club-orange">
                    </div>

                    <div>
                        <label for="type" class="block text-sm font-medium text-gray-700 mb-1">
                            Type *
                        </label>
                        <select id="type"
                                name="type"
                                required
                                onchange="toggleTypeFields(this.value)"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-club-orange focus:border-club-orange">
                            <option value="page">Page du site</option>
                            <option value="route">Route Symfony</option>
                            <option value="url">URL personnalis√©e</option>
                            <option value="dropdown">Menu d√©roulant</option>
                        </select>
                    </div>

                    <!-- Champs conditionnels selon le type -->
                    <div id="field-page">
                        <label for="page_id" class="block text-sm font-medium text-gray-700 mb-1">
                            Page
                        </label>
                        <select id="page_id"
                                name="page_id"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-club-orange focus:border-club-orange">
                            <option value="">-- S√©lectionner une page --</option>
                            {% for page in pages %}
                                <option value="{{ page.id }}">{{ page.title }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div id="field-route" style="display: none;">
                        <label for="route" class="block text-sm font-medium text-gray-700 mb-1">
                            Route
                        </label>
                        <select id="route"
                                name="route"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-club-orange focus:border-club-orange">
                            <option value="">-- S√©lectionner une route --</option>
                            {% for routeName, routeLabel in availableRoutes %}
                                <option value="{{ routeName }}">{{ routeLabel }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div id="field-url" style="display: none;">
                        <label for="custom_url" class="block text-sm font-medium text-gray-700 mb-1">
                            URL
                        </label>
                        <input type="url"
                               id="custom_url"
                               name="custom_url"
                               placeholder="https://..."
                               class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-club-orange focus:border-club-orange">
                    </div>

                    <div>
                        <label for="parent_id" class="block text-sm font-medium text-gray-700 mb-1">
                            Parent (optionnel)
                        </label>
                        <select id="parent_id"
                                name="parent_id"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-club-orange focus:border-club-orange">
                            <option value="">-- Racine --</option>
                            {% for item in menu.items %}
                                {% if item.parent is null %}
                                    <option value="{{ item.id }}">{{ item.label }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label for="icon" class="block text-sm font-medium text-gray-700 mb-1">
                            Ic√¥ne (emoji)
                        </label>
                        <div class="flex gap-2">
                            <input type="text"
                                   id="icon"
                                   name="icon"
                                   placeholder="Ex: üë•"
                                   maxlength="10"
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-club-orange focus:border-club-orange">
                            <button type="button"
                                    onclick="toggleEmojiPicker('icon')"
                                    class="px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-50 text-lg"
                                    title="Choisir un emoji">
                                üòÄ
                            </button>
                        </div>
                        <div id="emoji-picker-icon" class="hidden mt-2 p-3 border border-gray-200 rounded-lg bg-gray-50 max-h-64 overflow-y-auto">
                            {% include 'admin/menus/_emoji_picker.html.twig' with {target: 'icon'} %}
                        </div>
                    </div>

                    <div>
                        <label class="flex items-center">
                            <input type="checkbox"
                                   name="open_new_tab"
                                   value="1"
                                   class="rounded border-gray-300 text-club-orange focus:ring-club-orange">
                            <span class="ml-2 text-sm text-gray-700">Ouvrir dans un nouvel onglet</span>
                        </label>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Restreindre aux r√¥les
                        </label>
                        <div class="space-y-1">
                            <label class="flex items-center">
                                <input type="checkbox" name="roles[]" value="ROLE_USER" class="rounded border-gray-300 text-club-orange">
                                <span class="ml-2 text-sm text-gray-600">Membres connect√©s</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="roles[]" value="ROLE_ADMIN" class="rounded border-gray-300 text-club-orange">
                                <span class="ml-2 text-sm text-gray-600">Administrateurs</span>
                            </label>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Laisser vide = visible par tous</p>
                    </div>

                    <button type="submit"
                            class="w-full px-4 py-2 bg-club-orange text-white rounded-md hover:bg-club-orange-dark">
                        Ajouter
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% macro render_menu_item(item) %}
    <li class="menu-item border border-gray-200 rounded-md {{ item.active ? 'bg-white' : 'bg-gray-50 opacity-60' }}"
        data-id="{{ item.id }}">
        <div class="flex items-center justify-between p-3">
            <div class="flex items-center space-x-3">
                <span class="drag-handle cursor-move text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                    </svg>
                </span>
                {% if item.icon %}
                    <span class="text-lg">{{ item.icon }}</span>
                {% endif %}
                <div>
                    <span class="font-medium text-gray-900">{{ item.label }}</span>
                    <span class="ml-2 text-xs text-gray-500">
                        {% if item.type == 'page' %}
                            üìÑ {{ item.page ? item.page.title : 'Page non d√©finie' }}
                        {% elseif item.type == 'route' %}
                            üîó {{ item.route }}
                        {% elseif item.type == 'url' %}
                            üåê {{ item.customUrl|slice(0, 30) }}{% if item.customUrl|length > 30 %}...{% endif %}
                        {% elseif item.type == 'dropdown' %}
                            üìÇ Menu d√©roulant
                        {% endif %}
                    </span>
                    {% if not item.active %}
                        <span class="ml-2 text-xs text-red-600">(d√©sactiv√©)</span>
                    {% endif %}
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <a href="{{ path('admin_menus_items_edit', {id: item.id}) }}"
                   class="text-gray-400 hover:text-club-orange"
                   title="Modifier">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                </a>
                <form action="{{ path('admin_menus_items_delete', {id: item.id}) }}"
                      method="POST"
                      class="inline"
                      onsubmit="return confirm('Supprimer cet √©l√©ment ?')">
                    <button type="submit" class="text-gray-400 hover:text-red-600" title="Supprimer">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
        {% if item.children|length > 0 %}
            <ul class="nested-sortable ml-6 border-l-2 border-gray-200 pl-4 pb-3 space-y-2" data-parent-id="{{ item.id }}">
                {% for child in item.children %}
                    {{ _self.render_menu_item(child) }}
                {% endfor %}
            </ul>
        {% endif %}
    </li>
{% endmacro %}

<!-- SortableJS pour le drag & drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
function toggleTypeFields(type) {
    document.getElementById('field-page').style.display = type === 'page' ? 'block' : 'none';
    document.getElementById('field-route').style.display = type === 'route' ? 'block' : 'none';
    document.getElementById('field-url').style.display = type === 'url' ? 'block' : 'none';
}

function toggleEmojiPicker(targetId) {
    const picker = document.getElementById('emoji-picker-' + targetId);
    if (picker) {
        picker.classList.toggle('hidden');
    }
}

function selectEmoji(targetId, emoji) {
    const input = document.getElementById(targetId);
    if (input) {
        input.value = emoji;
        const picker = document.getElementById('emoji-picker-' + targetId);
        if (picker) {
            picker.classList.add('hidden');
        }
    }
}

// Fermer le picker en cliquant ailleurs
document.addEventListener('click', function(e) {
    if (!e.target.closest('[id^="emoji-picker-"]') && !e.target.closest('button[onclick^="toggleEmojiPicker"]')) {
        document.querySelectorAll('[id^="emoji-picker-"]').forEach(picker => {
            picker.classList.add('hidden');
        });
    }
});

// Configuration du drag & drop avec SortableJS
document.addEventListener('DOMContentLoaded', function() {
    const menuId = {{ menu.id }};
    const reorderUrl = '{{ path('admin_menus_reorder', {id: menu.id}) }}';

    // Fonction pour collecter l'ordre des items
    function collectItemsOrder(container, parentId = null) {
        const items = [];
        const children = container.querySelectorAll(':scope > .menu-item');

        children.forEach((item, index) => {
            const itemData = {
                id: parseInt(item.dataset.id),
                parent_id: parentId
            };
            items.push(itemData);

            // V√©rifier s'il y a des sous-√©l√©ments
            const nestedList = item.querySelector(':scope > .nested-sortable');
            if (nestedList) {
                const nestedItems = collectItemsOrder(nestedList, parseInt(item.dataset.id));
                items.push(...nestedItems);
            }
        });

        return items;
    }

    // Fonction pour sauvegarder l'ordre
    function saveOrder() {
        const mainList = document.getElementById('menu-items');
        if (!mainList) return;

        const items = collectItemsOrder(mainList);

        // Afficher un indicateur de sauvegarde
        showSaveIndicator('saving');

        fetch(reorderUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ items: items })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSaveIndicator('saved');
            } else {
                showSaveIndicator('error');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showSaveIndicator('error');
        });
    }

    // Indicateur de sauvegarde
    function showSaveIndicator(status) {
        let indicator = document.getElementById('save-indicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'save-indicator';
            indicator.className = 'fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white text-sm font-medium transition-all z-50';
            document.body.appendChild(indicator);
        }

        switch(status) {
            case 'saving':
                indicator.textContent = '‚è≥ Sauvegarde...';
                indicator.className = indicator.className.replace(/bg-\w+-\d+/g, '') + ' bg-blue-500';
                indicator.style.opacity = '1';
                break;
            case 'saved':
                indicator.textContent = '‚úÖ Ordre sauvegard√©';
                indicator.className = indicator.className.replace(/bg-\w+-\d+/g, '') + ' bg-green-500';
                setTimeout(() => { indicator.style.opacity = '0'; }, 2000);
                break;
            case 'error':
                indicator.textContent = '‚ùå Erreur de sauvegarde';
                indicator.className = indicator.className.replace(/bg-\w+-\d+/g, '') + ' bg-red-500';
                setTimeout(() => { indicator.style.opacity = '0'; }, 3000);
                break;
        }
    }

    // Initialiser Sortable sur la liste principale
    const mainList = document.getElementById('menu-items');
    if (mainList) {
        new Sortable(mainList, {
            group: 'menu-items',
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'bg-orange-100',
            chosenClass: 'bg-orange-50',
            dragClass: 'shadow-lg',
            onEnd: function(evt) {
                saveOrder();
            }
        });

        // Initialiser Sortable sur toutes les listes imbriqu√©es
        document.querySelectorAll('.nested-sortable').forEach(function(nestedList) {
            new Sortable(nestedList, {
                group: 'menu-items',
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'bg-orange-100',
                chosenClass: 'bg-orange-50',
                dragClass: 'shadow-lg',
                onEnd: function(evt) {
                    saveOrder();
                }
            });
        });
    }
});
</script>

<style>
.menu-item.sortable-ghost {
    opacity: 0.4;
}
.menu-item.sortable-chosen {
    cursor: grabbing;
}
.drag-handle:hover {
    cursor: grab;
}
.drag-handle:active {
    cursor: grabbing;
}
</style>
{% endblock %}
