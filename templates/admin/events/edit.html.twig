{% extends 'admin/base.html.twig' %}

{% block page_title %}{{ isNew ? 'Nouvel √âv√©nement' : 'Modifier l\'√âv√©nement' }}{% endblock %}

{% block breadcrumb_items %}
<li class="flex items-center">
    <svg class="flex-shrink-0 h-4 w-4 text-gray-300 mx-1" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
    </svg>
    <a href="{{ path('admin_events_list') }}" class="text-gray-500 hover:text-gray-700">√âv√©nements</a>
</li>
<li class="flex items-center">
    <svg class="flex-shrink-0 h-4 w-4 text-gray-300 mx-1" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
    </svg>
    <span class="text-gray-500">{{ isNew ? 'Nouveau' : 'Modifier' }}</span>
</li>
{% endblock %}

{% block content %}
<div class="max-w-4xl">
    <form method="POST" class="space-y-6">
        <div class="bg-white shadow-sm rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">Informations de l'√©v√©nement</h2>
            </div>
            
            <div class="px-6 py-4 space-y-6">
                <!-- Titre -->
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                        Titre de l'√©v√©nement *
                    </label>
                    <input type="text" id="title" name="title" 
                           value="{{ event.title ?? '' }}" 
                           required
                           class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                </div>

                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                        Description
                    </label>
                    <textarea id="description" name="description" rows="4"
                              class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">{{ event.description ?? '' }}</textarea>
                </div>

                <!-- Dates et heures -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="start_date" class="block text-sm font-medium text-gray-700 mb-2">
                            Date et heure de d√©but *
                        </label>
                        <input type="datetime-local" id="start_date" name="start_date" 
                               value="{{ event.startDate ? event.startDate|date('Y-m-d\\TH:i') : '' }}" 
                               required
                               class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                    </div>
                    <div>
                        <label for="end_date" class="block text-sm font-medium text-gray-700 mb-2">
                            Date et heure de fin
                        </label>
                        <input type="datetime-local" id="end_date" name="end_date" 
                               value="{{ event.endDate ? event.endDate|date('Y-m-d\\TH:i') : '' }}"
                               class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                    </div>
                </div>

                <!-- Lieu -->
                <div>
                    <label for="location" class="block text-sm font-medium text-gray-700 mb-2">
                        Lieu
                    </label>
                    <input type="text" id="location" name="location" 
                           value="{{ event.location ?? '' }}"
                           placeholder="Ex: Piscine Oc√©anis, Port de Vannes..."
                           class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                </div>

                <!-- Type d'√©v√©nement -->
                <div>
                    <label for="event_type" class="block text-sm font-medium text-gray-700 mb-2">
                        Type d'√©v√©nement *
                    </label>
                    {% if eventTypes|length > 0 %}
                        <select id="event_type" name="event_type_id" required
                                class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                            <option value="">-- S√©lectionner un type d'√©v√©nement --</option>
                            {% for eventType in eventTypes %}
                                <option value="{{ eventType.id }}" 
                                        data-color="{{ eventType.color }}"
                                        {{ event.eventType and event.eventType.id == eventType.id ? 'selected' : '' }}>
                                    {{ eventType.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-sm text-gray-500">
                            Aucun type ne vous convient ? <a href="{{ path('admin_event_types_new') }}" target="_blank" class="text-club-orange hover:text-club-orange-dark">Cr√©ez un nouveau type</a>
                        </p>
                    {% else %}
                        <div class="rounded-md bg-yellow-50 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-yellow-800">Aucun type d'√©v√©nement configur√©</h3>
                                    <div class="mt-2 text-sm text-yellow-700">
                                        <p>Vous devez d'abord cr√©er des types d'√©v√©nements avant de pouvoir cr√©er un √©v√©nement.</p>
                                    </div>
                                    <div class="mt-4">
                                        <a href="{{ path('admin_event_types_new') }}" 
                                           class="text-sm bg-yellow-50 text-yellow-800 rounded-md p-2 hover:bg-yellow-100">
                                            Cr√©er un type d'√©v√©nement ‚Üí
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Nombre maximum de participants -->
                <div>
                    <label for="max_participants" class="block text-sm font-medium text-gray-700 mb-2">
                        Nombre maximum de participants
                    </label>
                    <input type="number" id="max_participants" name="max_participants"
                           value="{{ event.maxParticipants ?? '' }}"
                           min="1"
                           placeholder="Laisser vide pour un nombre illimit√©"
                           class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                    <p class="mt-1 text-sm text-gray-500">
                        Si l'√©v√©nement est complet, les nouveaux inscrits seront automatiquement mis en liste d'attente.
                    </p>
                </div>

                <!-- Niveau minimum requis -->
                <div>
                    <label for="min_diving_level" class="block text-sm font-medium text-gray-700 mb-2">
                        Niveau minimum requis
                    </label>
                    <select id="min_diving_level" name="min_diving_level_id"
                            class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                        <option value="">-- Aucun niveau minimum --</option>
                        {% for level in divingLevels|default([]) %}
                            <option value="{{ level.id }}"
                                    {{ event.minDivingLevel and event.minDivingLevel.id == level.id ? 'selected' : '' }}>
                                {{ level.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-sm text-gray-500">
                        Les plongeurs n'ayant pas le niveau requis ne pourront pas s'inscrire.
                    </p>
                </div>

                <!-- Directeur de Plong√©e -->
                <div id="diving_director_section" class="bg-gray-50 rounded-lg p-4" style="display: none;">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">ü§ø Directeur de Plong√©e</h3>
                    <label for="diving_director_id" class="block text-sm font-medium text-gray-700 mb-2">
                        Directeur de Plong√©e (DP) *
                    </label>
                    <select id="diving_director_id" name="diving_director_id"
                            class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                        <option value="">-- S√©lectionner un DP --</option>
                        {% for dp in divingDirectors|default([]) %}
                            <option value="{{ dp.id }}"
                                    {{ event.divingDirector and event.divingDirector.id == dp.id ? 'selected' : '' }}>
                                {{ dp.fullName }}
                            </option>
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-sm text-gray-500">
                        Le DP est responsable de l'organisation et de la s√©curit√© de la plong√©e. Par d√©faut, vous √™tes le DP.
                    </p>
                </div>

                <!-- Pilote et bateau -->
                <div id="pilot_boat_section" class="bg-gray-50 rounded-lg p-4" style="display: none;">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">‚õµ Pilote et Bateau</h3>

                    <div class="space-y-4">
                        <!-- S√©lection du pilote -->
                        <div>
                            <label for="pilot_id" class="block text-sm font-medium text-gray-700 mb-2">
                                Pilote d√©sign√© *
                            </label>
                            <select id="pilot_id" name="pilot_id"
                                    class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                                <option value="">-- S√©lectionner un pilote --</option>
                                {% for pilot in pilots|default([]) %}
                                    <option value="{{ pilot.id }}"
                                            {{ event.pilot and event.pilot.id == pilot.id ? 'selected' : '' }}>
                                        {{ pilot.fullName }}
                                    </option>
                                {% endfor %}
                            </select>
                            <p class="mt-1 text-sm text-gray-500">
                                Seuls les membres ayant coch√© "Je suis pilote de bateau" dans leur profil apparaissent ici.
                            </p>
                        </div>

                        <!-- S√©lection du bateau -->
                        <div>
                            <label for="boat_id" class="block text-sm font-medium text-gray-700 mb-2">
                                Bateau utilis√© *
                            </label>
                            <select id="boat_id" name="boat_id"
                                    class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                                <option value="">-- S√©lectionner un bateau --</option>
                                {% for boat in boats|default([]) %}
                                    <option value="{{ boat.id }}"
                                            {{ event.boat and event.boat.id == boat.id ? 'selected' : '' }}
                                            data-capacity="{{ boat.capacity ?? '' }}">
                                        {{ boat.name }}{% if boat.capacity %} ({{ boat.capacity }} places){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                            <p class="mt-1 text-sm text-gray-500">
                                Si aucun bateau ne correspond, vous pouvez <a href="{{ path('admin_boats_new') }}" target="_blank" class="text-club-orange hover:text-club-orange-dark">en cr√©er un nouveau</a>.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Heures de rendez-vous -->
                <div class="sm:col-span-2">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Heures de rendez-vous</h3>
                        <p class="text-sm text-gray-600 mb-4">
                            D√©finissez les heures de RDV au club et/ou sur site. Les participants pourront choisir leur point de rendez-vous lors de l'inscription.
                        </p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- RDV Club -->
                            <div>
                                <label for="club_meeting_time" class="block text-sm font-medium text-gray-700 mb-2">
                                    üè† Heure de RDV au club
                                </label>
                                <input type="time" id="club_meeting_time" name="club_meeting_time"
                                       value="{{ event.clubMeetingTime ? event.clubMeetingTime|date('H:i') : '' }}"
                                       class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                                <p class="mt-1 text-sm text-gray-500">Pour ceux qui partent depuis le club</p>
                            </div>

                            <!-- RDV Site -->
                            <div>
                                <label for="site_meeting_time" class="block text-sm font-medium text-gray-700 mb-2">
                                    üåä Heure de RDV sur site
                                </label>
                                <input type="time" id="site_meeting_time" name="site_meeting_time"
                                       value="{{ event.siteMeetingTime ? event.siteMeetingTime|date('H:i') : '' }}"
                                       class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                                <p class="mt-1 text-sm text-gray-500">Pour ceux qui vont directement sur site</p>
                            </div>
                        </div>

                        <div class="mt-4 bg-blue-50 border border-blue-200 rounded-md p-3">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-blue-800">Note</h3>
                                    <div class="mt-2 text-sm text-blue-700">
                                        <p>Si vous ne d√©finissez qu'une seule heure, tous les participants se retrouveront au m√™me endroit.
                                        Si vous d√©finissez les deux, les participants pourront choisir leur point de rendez-vous lors de l'inscription.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- R√©currence -->
                <div class="sm:col-span-2">
                    <div class="flex items-center mb-4">
                        <input type="checkbox"
                               name="is_recurring"
                               id="is_recurring"
                               value="1"
                               {{ event.isRecurring ? 'checked' : '' }}
                               class="h-4 w-4 text-club-orange focus:ring-club-orange border-gray-300 rounded">
                        <label for="is_recurring" class="ml-2 block text-sm font-medium text-gray-900">
                            √âv√©nement r√©current
                        </label>
                    </div>
                    
                    <div id="recurrence_fields" style="display: {{ event.isRecurring ? 'block' : 'none' }}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                            <!-- Type de r√©currence -->
                            <div>
                                <label for="recurrence_type" class="block text-sm font-medium text-gray-700 mb-2">
                                    Fr√©quence
                                </label>
                                <select name="recurrence_type" id="recurrence_type"
                                        class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                                    <option value="weekly" {{ event.recurrenceType == 'weekly' ? 'selected' : '' }}>Hebdomadaire</option>
                                    <option value="monthly" {{ event.recurrenceType == 'monthly' ? 'selected' : '' }}>Mensuel</option>
                                    <option value="daily" {{ event.recurrenceType == 'daily' ? 'selected' : '' }}>Quotidien</option>
                                </select>
                            </div>
                            
                            <!-- Intervalle -->
                            <div>
                                <label for="recurrence_interval" class="block text-sm font-medium text-gray-700 mb-2">
                                    R√©p√©ter tous les
                                </label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" 
                                           name="recurrence_interval" 
                                           id="recurrence_interval" 
                                           value="{{ event.recurrenceInterval ?? 1 }}"
                                           min="1" max="12"
                                           class="block w-20 border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                                    <span class="text-sm text-gray-500" id="interval_label">semaine(s)</span>
                                </div>
                            </div>
                            
                            <!-- Jours de la semaine (pour hebdomadaire) -->
                            <div class="md:col-span-2" id="weekdays_field" style="display: {{ event.recurrenceType == 'weekly' ? 'block' : 'none' }}">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Jours de la semaine
                                </label>
                                <div class="flex flex-wrap gap-2">
                                    {% set weekdays = [
                                        {value: 1, label: 'Lun'},
                                        {value: 2, label: 'Mar'},
                                        {value: 3, label: 'Mer'},
                                        {value: 4, label: 'Jeu'},
                                        {value: 5, label: 'Ven'},
                                        {value: 6, label: 'Sam'},
                                        {value: 7, label: 'Dim'}
                                    ] %}
                                    {% for weekday in weekdays %}
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" 
                                                   name="recurrence_weekdays[]" 
                                                   value="{{ weekday.value }}"
                                                   {{ event.recurrenceWeekdays and weekday.value in event.recurrenceWeekdays ? 'checked' : '' }}
                                                   class="h-4 w-4 text-club-orange focus:ring-club-orange border-gray-300 rounded">
                                            <span class="ml-1 text-sm text-gray-700">{{ weekday.label }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                                <p class="mt-1 text-xs text-gray-500">Si aucun jour n'est s√©lectionn√©, l'√©v√©nement se r√©p√©tera le m√™me jour de la semaine</p>
                            </div>
                            
                            <!-- Date de fin de r√©currence -->
                            <div class="md:col-span-2">
                                <label for="recurrence_end_date" class="block text-sm font-medium text-gray-700 mb-2">
                                    R√©p√©ter jusqu'au
                                </label>
                                <input type="date" 
                                       name="recurrence_end_date" 
                                       id="recurrence_end_date" 
                                       value="{{ event.recurrenceEndDate ? event.recurrenceEndDate|date('Y-m-d') : '' }}"
                                       class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                                <p class="mt-1 text-xs text-gray-500">Laisser vide pour r√©p√©ter sur 1 an maximum</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statut (pour modification seulement) -->
        <div class="bg-white shadow-sm rounded-lg">
            <div class="px-6 py-4">

                {% if not isNew %}
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
                        Statut
                    </label>
                    <select id="status" name="status" 
                            class="block w-48 border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                        <option value="active" {{ event.status == 'active' ? 'selected' : '' }}>Actif</option>
                        <option value="cancelled" {{ event.status == 'cancelled' ? 'selected' : '' }}>Annul√©</option>
                        <option value="completed" {{ event.status == 'completed' ? 'selected' : '' }}>Termin√©</option>
                        <option value="draft" {{ event.status == 'draft' ? 'selected' : '' }}>Brouillon</option>
                    </select>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-between">
            <a href="{{ path('admin_events_list') }}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Annuler
            </a>
            
            <div class="flex items-center space-x-3">
                {% if not isNew %}
                    <a href="{{ path('calendar_event_detail', {id: event.id}) }}" 
                       target="_blank"
                       class="inline-flex items-center px-4 py-2 border border-club-blue text-sm font-medium rounded-md text-club-blue bg-white hover:bg-club-blue hover:text-white">
                        <svg class="-ml-1 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-2M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                        Pr√©visualiser
                    </a>
                {% endif %}
                
                <button type="submit" 
                        class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-club-orange hover:bg-club-orange-dark">
                    <svg class="-ml-1 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    {{ isNew ? 'Cr√©er l\'√©v√©nement' : 'Enregistrer les modifications' }}
                </button>
            </div>
        </div>
    </form>
</div>

<script>
function toggleRecurrenceFields(isRecurring) {
    console.log('toggleRecurrenceFields called with:', isRecurring);
    const fields = document.getElementById('recurrence_fields');
    if (fields) {
        fields.style.display = isRecurring ? 'block' : 'none';
        console.log('Recurrence fields display set to:', fields.style.display);
    } else {
        console.error('recurrence_fields element not found');
    }
}

function toggleWeekdayFields(recurrenceType) {
    console.log('toggleWeekdayFields called with:', recurrenceType);
    const weekdaysField = document.getElementById('weekdays_field');
    const intervalLabel = document.getElementById('interval_label');

    if (weekdaysField && intervalLabel) {
        if (recurrenceType === 'weekly') {
            weekdaysField.style.display = 'block';
            intervalLabel.textContent = 'semaine(s)';
        } else if (recurrenceType === 'monthly') {
            weekdaysField.style.display = 'none';
            intervalLabel.textContent = 'mois';
        } else if (recurrenceType === 'daily') {
            weekdaysField.style.display = 'none';
            intervalLabel.textContent = 'jour(s)';
        }
        console.log('Weekdays field display:', weekdaysField.style.display);
    } else {
        console.error('weekdays_field or interval_label elements not found');
    }
}

// === Gestion de la r√©currence ===
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing recurrence controls');

    // Gestion du checkbox de r√©currence
    const recurringCheckbox = document.getElementById('is_recurring');
    if (recurringCheckbox) {
        console.log('Found recurring checkbox, adding event listener');
        recurringCheckbox.addEventListener('change', function() {
            console.log('Checkbox changed, value:', this.checked);
            toggleRecurrenceFields(this.checked);
        });
    } else {
        console.error('Recurring checkbox not found!');
    }

    // Gestion du select de type de r√©currence
    const recurrenceType = document.getElementById('recurrence_type');
    if (recurrenceType) {
        console.log('Found recurrence type select, adding event listener');
        recurrenceType.addEventListener('change', function() {
            console.log('Recurrence type changed, value:', this.value);
            toggleWeekdayFields(this.value);
        });
        // Initialiser l'√©tat
        toggleWeekdayFields(recurrenceType.value);
    } else {
        console.log('Recurrence type select not found (normal for initial state)');
    }

    // === Gestion des champs DP et pilote selon le type d'√©v√©nement ===
    const eventTypeSelect = document.getElementById('event_type');
    const divingDirectorSection = document.getElementById('diving_director_section');
    const pilotBoatSection = document.getElementById('pilot_boat_section');

    // Stocker les infos des types d'√©v√©nements
    const eventTypesData = {
        {% for eventType in eventTypes|default([]) %}
        '{{ eventType.id }}': {
            requiresDivingDirector: {{ eventType.requiresDivingDirector ? 'true' : 'false' }},
            requiresPilot: {{ eventType.requiresPilot ? 'true' : 'false' }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };

    function updateEventTypeFields() {
        const selectedTypeId = eventTypeSelect.value;
        const typeData = eventTypesData[selectedTypeId];

        if (typeData) {
            // Afficher/masquer la section DP
            if (typeData.requiresDivingDirector) {
                divingDirectorSection.style.display = 'block';
            } else {
                divingDirectorSection.style.display = 'none';
            }

            // Afficher/masquer la section pilote/bateau
            if (typeData.requiresPilot) {
                pilotBoatSection.style.display = 'block';
            } else {
                pilotBoatSection.style.display = 'none';
            }
        } else {
            // Aucun type s√©lectionn√©, masquer tout
            divingDirectorSection.style.display = 'none';
            pilotBoatSection.style.display = 'none';
        }
    }

    if (eventTypeSelect) {
        eventTypeSelect.addEventListener('change', updateEventTypeFields);
        // Initialiser l'√©tat au chargement
        updateEventTypeFields();
    }

    // === Auto-remplir le nombre max de participants selon le bateau s√©lectionn√© ===
    const boatSelect = document.getElementById('boat_id');
    const maxParticipantsInput = document.getElementById('max_participants');

    if (boatSelect && maxParticipantsInput) {
        boatSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const boatCapacity = selectedOption.getAttribute('data-capacity');

            if (boatCapacity && boatCapacity !== '') {
                // Remplir automatiquement le champ max participants avec la capacit√© du bateau
                maxParticipantsInput.value = boatCapacity;

                // Ajouter un effet visuel pour montrer que c'est auto-rempli
                maxParticipantsInput.classList.add('bg-green-50', 'border-green-300');
                setTimeout(() => {
                    maxParticipantsInput.classList.remove('bg-green-50', 'border-green-300');
                }, 1500);
            }
        });
    }
});
</script>
{% endblock %}