{% extends 'plongee_base.html.twig' %}

{% block title %}Calendrier des Activit√©s - Club Subaquatique des V√©n√®tes{% endblock %}

{% block body %}
<div class="calendar-page">
    <div class="calendar-container">
        <!-- Header -->
        <div class="calendar-header">
            <h1 class="calendar-title">
                Calendrier des Activit√©s
            </h1>
            <p class="calendar-subtitle">
                Toutes les sorties, formations et √©v√©nements du club
            </p>
        </div>

        <div class="calendar-layout">
            <!-- Calendrier principal -->
            <div class="calendar-main">
                <div class="calendar-card">
                    <!-- Navigation du calendrier -->
                    <div class="calendar-nav">
                        <div class="calendar-nav-controls">
                            <a href="{{ path('public_calendar', {year: prev_year, month: prev_month}) }}"
                               class="calendar-nav-btn">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                </svg>
                            </a>
                            <h2 class="calendar-month-title">
                                {% set months = ['', 'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'] %}
                                {{ months[current_month] }} {{ current_year }}
                            </h2>
                            <a href="{{ path('public_calendar', {year: next_year, month: next_month}) }}"
                               class="calendar-nav-btn">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </a>
                        </div>
                        <a href="{{ path('public_calendar') }}"
                           class="calendar-today-btn">
                            Aujourd'hui
                        </a>
                    </div>

                    <!-- Grille du calendrier -->
                    {% set firstDay = date(current_year ~ '-' ~ current_month ~ '-01') %}
                    {% set startOfWeek = firstDay.format('N') %}
                    {% set daysInMonth = firstDay.format('t') %}

                    <div class="calendar-grid">
                        <!-- En-t√™tes des jours -->
                        <div class="calendar-day-header">Lun</div>
                        <div class="calendar-day-header">Mar</div>
                        <div class="calendar-day-header">Mer</div>
                        <div class="calendar-day-header">Jeu</div>
                        <div class="calendar-day-header">Ven</div>
                        <div class="calendar-day-header">Sam</div>
                        <div class="calendar-day-header">Dim</div>

                        <!-- Cases vides du d√©but -->
                        {% if startOfWeek > 1 %}
                            {% for i in 1..(startOfWeek - 1) %}
                                <div class="calendar-day-empty"></div>
                            {% endfor %}
                        {% endif %}

                        <!-- Jours du mois -->
                        {% for day in 1..daysInMonth %}
                            {% set currentDate = date(current_year ~ '-' ~ current_month ~ '-' ~ day) %}
                            {% set isToday = currentDate.format('Y-m-d') == 'now'|date('Y-m-d') %}
                            {% set dayEvents = [] %}
                            {% for event in events %}
                                {% if event.startDate.format('Y-m-d') == currentDate.format('Y-m-d') %}
                                    {% set dayEvents = dayEvents|merge([event]) %}
                                {% endif %}
                            {% endfor %}

                            <div class="calendar-day {{ isToday ? 'calendar-day-today' : '' }}">
                                <div class="calendar-day-number">
                                    {{ day }}
                                </div>
                                {% for event in dayEvents|slice(0, 2) %}
                                    <a href="{{ path('calendar_event_detail', {id: event.id}) }}"
                                       class="calendar-event"
                                       style="background-color: {{ event.color ?? '#FD7E29' }}"
                                       title="{{ event.title }}">
                                        {{ event.title }}
                                    </a>
                                {% endfor %}
                                {% if dayEvents|length > 2 %}
                                    <div class="calendar-day-more">+{{ dayEvents|length - 2 }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}

                        <!-- Cases vides de fin -->
                        {% set emptyCellsAtStart = startOfWeek > 1 ? (startOfWeek - 1) : 0 %}
                        {% set totalCells = emptyCellsAtStart + daysInMonth %}
                        {% set remainingCells = 42 - totalCells %}
                        {% if remainingCells > 0 %}
                            {% for i in 1..remainingCells %}
                                <div class="calendar-day-empty"></div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Sidebar avec √©v√©nements √† venir -->
            <div class="calendar-sidebar">
                <div class="calendar-sidebar-card">
                    <h3 class="calendar-sidebar-title">Prochains √âv√©nements</h3>
                    {% if upcoming_events is empty %}
                        <p class="calendar-upcoming-empty">Aucun √©v√©nement pr√©vu</p>
                    {% else %}
                        <div class="calendar-upcoming-list">
                            {% for event in upcoming_events %}
                                <div class="calendar-upcoming-event">
                                    <div class="calendar-upcoming-header">
                                        <div class="calendar-upcoming-content">
                                            <h4 class="calendar-upcoming-title">
                                                <a href="{{ path('calendar_event_detail', {id: event.id}) }}">
                                                    {{ event.title }}
                                                </a>
                                            </h4>
                                            <p class="calendar-upcoming-date">
                                                {{ event.startDate|date_fr('d/m √† H:i') }}
                                            </p>
                                            {% if event.location %}
                                                <p class="calendar-upcoming-location">
                                                    üìç {{ event.location }}
                                                </p>
                                            {% endif %}
                                        </div>
                                        <span class="calendar-event-badge"
                                              style="background-color: {{ event.color ?? '#FD7E29' }}1A; color: {{ event.color ?? '#FD7E29' }}">
                                            {{ event.typeDisplayName }}
                                        </span>
                                    </div>
                                    {% if event.maxParticipants %}
                                        <div class="calendar-event-places">
                                            <div class="calendar-event-places-header">
                                                <span>Places:</span>
                                                <span>{{ event.currentParticipants }}/{{ event.maxParticipants }}</span>
                                            </div>
                                            <div class="calendar-event-places-bar">
                                                {% set percentage = event.maxParticipants > 0 ? (event.currentParticipants / event.maxParticipants * 100) : 0 %}
                                                <div class="calendar-event-places-fill"
                                                     style="width: {{ percentage }}%"></div>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- L√©gende des types d'√©v√©nements -->
                {% if event_types is not empty %}
                <div class="calendar-sidebar-card">
                    <h3 class="calendar-sidebar-title calendar-sidebar-title-sm">Types d'activit√©s</h3>
                    <div class="calendar-legend">
                        {% for event_type in event_types %}
                            <div class="calendar-legend-item">
                                <div class="calendar-legend-color" style="background-color: {{ event_type.color }}"></div>
                                <span>{{ event_type.name }}</span>
                                {% if event_type.description %}
                                    <span class="calendar-legend-desc">- {{ event_type.description }}</span>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <div class="calendar-sidebar-card">
                    <h3 class="calendar-sidebar-title calendar-sidebar-title-sm">Types d'activit√©s</h3>
                    <div class="calendar-legend-empty">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a1.994 1.994 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                        </svg>
                        <p>Aucun type d'√©v√©nement configur√©</p>
                        <p>
                            <a href="{{ path('admin_event_types_list') }}">
                                Cr√©er des types d'√©v√©nements
                            </a>
                        </p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
