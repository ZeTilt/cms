{% extends 'plongee_base.html.twig' %}

{% block title %}Mon Profil{% endblock %}

{% block body %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- En-t√™te -->
    <div class="bg-white shadow-sm rounded-lg mb-8">
        <div class="px-6 py-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    {% if user.avatarFile %}
                        <img src="{{ asset('uploads/avatars/' ~ user.avatarFile) }}"
                             alt="Avatar {{ user.fullName }}"
                             class="h-20 w-20 rounded-full object-cover border-2 border-club-orange">
                    {% else %}
                        <div class="h-20 w-20 rounded-full bg-club-orange flex items-center justify-center border-2 border-club-orange">
                            <span class="text-2xl font-medium text-white">
                                {{ user.fullName|slice(0, 1)|upper }}
                            </span>
                        </div>
                    {% endif %}
                    <div class="ml-4">
                        <h1 class="text-2xl font-bold text-gray-900">{{ user.fullName }}</h1>
                        <p class="text-sm text-gray-500">{{ user.email }}</p>
                    </div>
                </div>

                <!-- Upload avatar -->
                <div class="flex flex-col items-end">
                    <form method="POST" action="{{ path('user_profile_upload_avatar') }}" enctype="multipart/form-data" id="avatar-form">
                        <label for="avatar-input" class="cursor-pointer inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                            <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            Changer l'avatar
                        </label>
                        <input type="file" id="avatar-input" name="avatar" accept="image/*" class="hidden" onchange="document.getElementById('avatar-form').submit()">
                    </form>
                    {% if user.avatarFile %}
                        <form method="POST" action="{{ path('user_profile_delete_avatar') }}" class="mt-2">
                            <button type="submit" class="text-xs text-red-600 hover:text-red-800" onclick="return confirm('Supprimer votre avatar ?')">
                                Supprimer l'avatar
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Informations de base -->
        <div class="px-6 py-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <dt class="text-sm font-medium text-gray-500">Statut</dt>
                    <dd class="mt-1 text-sm text-gray-900">
                        {% if user.status == 'approved' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                ‚úì Approuv√©
                            </span>
                        {% elseif user.status == 'pending' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                ‚è≥ En attente
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                ‚ùå {{ user.status|title }}
                            </span>
                        {% endif %}
                    </dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Membre depuis</dt>
                    <dd class="mt-1 text-sm text-gray-900">{{ user.createdAt|date('d/m/Y') }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Derni√®re mise √† jour</dt>
                    <dd class="mt-1 text-sm text-gray-900">
                        {% if user.updatedAt %}
                            {{ user.updatedAt|date('d/m/Y') }}
                        {% else %}
                            Non modifi√©
                        {% endif %}
                    </dd>
                </div>
            </div>
        </div>
    </div>

    <!-- Niveaux et Activit√©s -->
    <div class="bg-white shadow-sm rounded-lg mb-8">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">üèä Activit√©s et Niveaux</h2>
            <p class="mt-1 text-sm text-gray-500">
                D√©finissez vos activit√©s et niveaux pour acc√©der aux √©v√©nements correspondants.
            </p>
        </div>

        <div class="px-6 py-6">
            <form method="POST" action="{{ path('user_profile_activities') }}" class="space-y-6">
                <!-- Activit√©s pratiqu√©es -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">
                        Mes activit√©s
                    </label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="is_diver" value="1" {{ user.isDiver ? 'checked' : '' }}
                                   onchange="document.getElementById('diving_level_section').style.display = this.checked ? 'block' : 'none'"
                                   class="h-4 w-4 text-club-orange focus:ring-club-orange border-gray-300 rounded">
                            <span class="ml-2 text-sm text-gray-700">ü§ø Je pratique la plong√©e bouteille</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="is_freediver" value="1" {{ user.isFreediver ? 'checked' : '' }}
                                   onchange="document.getElementById('freediving_level_section').style.display = this.checked ? 'block' : 'none'"
                                   class="h-4 w-4 text-club-orange focus:ring-club-orange border-gray-300 rounded">
                            <span class="ml-2 text-sm text-gray-700">üåä Je pratique l'apn√©e</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="is_pilot" value="1" {{ user.isPilot ? 'checked' : '' }}
                                   class="h-4 w-4 text-club-orange focus:ring-club-orange border-gray-300 rounded">
                            <span class="ml-2 text-sm text-gray-700">‚õµ Je suis pilote de bateau</span>
                        </label>
                    </div>
                </div>

                <!-- Niveau de plong√©e -->
                <div id="diving_level_section" style="display: {{ user.isDiver ? 'block' : 'none' }}">
                    <label for="diving_level_id" class="block text-sm font-medium text-gray-700 mb-2">
                        Niveau de plong√©e bouteille
                    </label>
                    <select name="diving_level_id" id="diving_level_id"
                            class="block w-full md:w-96 border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                        <option value="">-- S√©lectionner mon niveau --</option>
                        {% for level in divingLevels %}
                            <option value="{{ level.id }}"
                                    {{ user.highestDivingLevel and user.highestDivingLevel.id == level.id ? 'selected' : '' }}>
                                {{ level.name }}
                                {% if level.description %} - {{ level.description }}{% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Niveau d'apn√©e -->
                <div id="freediving_level_section" style="display: {{ user.isFreediver ? 'block' : 'none' }}">
                    <label for="freediving_level_id" class="block text-sm font-medium text-gray-700 mb-2">
                        Niveau d'apn√©e
                    </label>
                    <select name="freediving_level_id" id="freediving_level_id"
                            class="block w-full md:w-96 border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                        <option value="">-- S√©lectionner mon niveau --</option>
                        {% for level in freedivingLevels %}
                            <option value="{{ level.id }}"
                                    {{ user.highestFreedivingLevel and user.highestFreedivingLevel.id == level.id ? 'selected' : '' }}>
                                {{ level.name }}
                                {% if level.description %} - {{ level.description }}{% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="flex items-center justify-end pt-4 border-t">
                    <button type="submit"
                            class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-club-orange hover:bg-club-orange-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-club-orange">
                        <svg class="-ml-1 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Informations personnelles -->
    <div class="bg-white shadow-sm rounded-lg mb-8">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">üë§ Informations Personnelles</h2>
            <p class="mt-1 text-sm text-gray-500">
                Ces informations sont visibles uniquement par les Directeurs de Plong√©e.
            </p>
        </div>

        <div class="px-6 py-6">
            <form method="POST" action="{{ path('user_profile_personal_info') }}" class="space-y-6">
                <!-- T√©l√©phone mobile -->
                <div>
                    <label for="phone_number" class="block text-sm font-medium text-gray-700 mb-2">
                        üì± Num√©ro de t√©l√©phone mobile
                    </label>
                    <input type="tel"
                           name="phone_number"
                           id="phone_number"
                           value="{{ user.phoneNumber ?? '' }}"
                           placeholder="Ex: 06 12 34 56 78"
                           class="block w-full md:w-96 border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                    <p class="mt-1 text-xs text-gray-500">
                        Pour vous contacter en cas d'urgence
                    </p>
                </div>

                <!-- Date de naissance -->
                <div>
                    <label for="date_of_birth" class="block text-sm font-medium text-gray-700 mb-2">
                        üéÇ Date de naissance
                    </label>
                    <input type="date"
                           name="date_of_birth"
                           id="date_of_birth"
                           value="{{ user.dateOfBirth ? user.dateOfBirth|date('Y-m-d') : '' }}"
                           class="block w-full md:w-64 border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                    <p class="mt-1 text-xs text-gray-500">
                        Utile pour les assurances et validit√© des certificats
                    </p>
                </div>

                <!-- Adresse postale -->
                <div>
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-2">
                        üè† Adresse postale
                    </label>
                    <textarea name="address"
                              id="address"
                              rows="3"
                              placeholder="Num√©ro et rue&#10;Code postal et ville"
                              class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">{{ user.address ?? '' }}</textarea>
                    <p class="mt-1 text-xs text-gray-500">
                        Pour l'envoi de documents administratifs
                    </p>
                </div>

                <div class="flex items-center justify-between pt-4 border-t">
                    <div class="text-sm text-gray-500">
                        <p><strong>üîí Confidentialit√© :</strong></p>
                        <p class="mt-1">Ces informations ne sont visibles que par les DP et ne sont jamais partag√©es.</p>
                    </div>

                    <button type="submit"
                            class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-club-orange hover:bg-club-orange-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-club-orange">
                        <svg class="-ml-1 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Certificat m√©dical -->
    <div class="bg-white shadow-sm rounded-lg mb-8">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">üè• Certificat M√©dical</h2>
            <p class="mt-1 text-sm text-gray-500">
                Ajoutez votre certificat m√©dical pour permettre aux DP de v√©rifier sa validit√©.
            </p>
        </div>

        <div class="px-6 py-6">
            <form method="POST" action="{{ path('user_profile_medical_certificate') }}" enctype="multipart/form-data" class="space-y-6">
                <!-- Statut actuel -->
                {% if user.medicalCertificateFile %}
                    <div class="rounded-md p-4 {{ user.isMedicalCertificateValid() ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200' }}">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                {% if user.isMedicalCertificateValid() %}
                                    <svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                {% else %}
                                    <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                    </svg>
                                {% endif %}
                            </div>
                            <div class="ml-3 flex-1">
                                <h3 class="text-sm font-medium {{ user.isMedicalCertificateValid() ? 'text-green-800' : 'text-red-800' }}">
                                    {% if user.isMedicalCertificateValid() %}
                                        ‚úì Certificat m√©dical valide
                                    {% else %}
                                        ‚ö†Ô∏è Certificat m√©dical expir√©
                                    {% endif %}
                                </h3>
                                <div class="mt-2 text-sm {{ user.isMedicalCertificateValid() ? 'text-green-700' : 'text-red-700' }}">
                                    <p>Date d'expiration : {{ user.medicalCertificateExpiry|date('d/m/Y') }}</p>
                                    <p class="mt-1">
                                        <a href="{{ asset('uploads/medical_certificates/' ~ user.medicalCertificateFile) }}"
                                           target="_blank"
                                           class="underline hover:no-underline">
                                            Voir le certificat
                                        </a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="rounded-md bg-yellow-50 border border-yellow-200 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-yellow-800">
                                    Aucun certificat m√©dical
                                </h3>
                                <p class="mt-2 text-sm text-yellow-700">
                                    Vous devez fournir un certificat m√©dical valide pour participer aux plong√©es.
                                </p>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- Upload du certificat -->
                <div>
                    <label for="medical_certificate_file" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ user.medicalCertificateFile ? 'Remplacer le certificat' : 'Fichier du certificat' }}
                    </label>
                    <input type="file"
                           name="medical_certificate_file"
                           id="medical_certificate_file"
                           accept=".pdf,.jpg,.jpeg,.png"
                           class="block w-full text-sm text-gray-500
                                  file:mr-4 file:py-2 file:px-4
                                  file:rounded-md file:border-0
                                  file:text-sm file:font-medium
                                  file:bg-club-orange file:text-white
                                  hover:file:bg-club-orange-dark
                                  cursor-pointer">
                    <p class="mt-1 text-xs text-gray-500">
                        Formats accept√©s : PDF, JPG, PNG (max 5 Mo)
                    </p>
                </div>

                <!-- Date d'expiration -->
                <div>
                    <label for="medical_certificate_expiry" class="block text-sm font-medium text-gray-700 mb-2">
                        Date d'expiration *
                    </label>
                    <input type="date"
                           name="medical_certificate_expiry"
                           id="medical_certificate_expiry"
                           value="{{ user.medicalCertificateExpiry ? user.medicalCertificateExpiry|date('Y-m-d') : '' }}"
                           required
                           class="block w-full md:w-64 border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                    <p class="mt-1 text-xs text-gray-500">
                        Un certificat m√©dical est g√©n√©ralement valide 1 an
                    </p>
                </div>

                <div class="flex items-center justify-between pt-4">
                    <div class="text-sm text-gray-500">
                        <p><strong>Informations importantes :</strong></p>
                        <ul class="mt-1 list-disc list-inside space-y-1">
                            <li>Le certificat doit √™tre en cours de validit√©</li>
                            <li>Visible uniquement par les Directeurs de Plong√©e</li>
                            <li>Vous serez notifi√© 30 jours avant l'expiration</li>
                        </ul>
                    </div>

                    <button type="submit"
                            class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-club-orange hover:bg-club-orange-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-club-orange">
                        <svg class="-ml-1 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        Enregistrer le certificat
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Licence FFESSM -->
    <div class="bg-white shadow-sm rounded-lg mb-8">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">üé´ Licence FFESSM</h2>
            <p class="mt-1 text-sm text-gray-500">
                Ajoutez votre justificatif de licence pour permettre aux DP de v√©rifier sa validit√©.
            </p>
        </div>

        <div class="px-6 py-6">
            <form method="POST" action="{{ path('user_profile_licence') }}" enctype="multipart/form-data" class="space-y-6">
                <!-- Statut actuel -->
                {% if user.licenceFile %}
                    <div class="rounded-md p-4 {{ user.isLicenceValid() ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200' }}">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                {% if user.isLicenceValid() %}
                                    <svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                {% else %}
                                    <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                    </svg>
                                {% endif %}
                            </div>
                            <div class="ml-3 flex-1">
                                <h3 class="text-sm font-medium {{ user.isLicenceValid() ? 'text-green-800' : 'text-red-800' }}">
                                    {% if user.isLicenceValid() %}
                                        ‚úì Licence valide
                                    {% else %}
                                        ‚ö†Ô∏è Licence expir√©e
                                    {% endif %}
                                </h3>
                                <div class="mt-2 text-sm {{ user.isLicenceValid() ? 'text-green-700' : 'text-red-700' }}">
                                    {% if user.licenceNumber %}
                                        <p>Num√©ro : {{ user.licenceNumber }}</p>
                                    {% endif %}
                                    <p>Date d'expiration : {{ user.licenceExpiry|date('d/m/Y') }}</p>
                                    <p class="mt-1">
                                        <a href="{{ asset('uploads/licences/' ~ user.licenceFile) }}"
                                           target="_blank"
                                           class="underline hover:no-underline">
                                            Voir le justificatif
                                        </a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="rounded-md bg-yellow-50 border border-yellow-200 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-yellow-800">
                                    Aucun justificatif de licence
                                </h3>
                                <p class="mt-2 text-sm text-yellow-700">
                                    Vous devez fournir un justificatif de licence valide pour participer aux plong√©es.
                                </p>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- Num√©ro de licence -->
                <div>
                    <label for="licence_number" class="block text-sm font-medium text-gray-700 mb-2">
                        Num√©ro de licence
                    </label>
                    <input type="text"
                           name="licence_number"
                           id="licence_number"
                           value="{{ user.licenceNumber ?? '' }}"
                           placeholder="Ex: 123456789"
                           class="block w-full md:w-96 border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                    <p class="mt-1 text-xs text-gray-500">
                        Num√©ro visible sur votre carte de licence
                    </p>
                </div>

                <!-- Upload du justificatif -->
                <div>
                    <label for="licence_file" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ user.licenceFile ? 'Remplacer le justificatif' : 'Fichier du justificatif' }}
                    </label>
                    <input type="file"
                           name="licence_file"
                           id="licence_file"
                           accept=".pdf,.jpg,.jpeg,.png"
                           class="block w-full text-sm text-gray-500
                                  file:mr-4 file:py-2 file:px-4
                                  file:rounded-md file:border-0
                                  file:text-sm file:font-medium
                                  file:bg-club-orange file:text-white
                                  hover:file:bg-club-orange-dark
                                  cursor-pointer">
                    <p class="mt-1 text-xs text-gray-500">
                        Formats accept√©s : PDF, JPG, PNG (max 5 Mo)
                    </p>
                </div>

                <!-- Date d'expiration -->
                <div>
                    <label for="licence_expiry" class="block text-sm font-medium text-gray-700 mb-2">
                        Date d'expiration (optionnelle)
                    </label>
                    <input type="date"
                           name="licence_expiry"
                           id="licence_expiry"
                           value="{{ user.licenceExpiry ? user.licenceExpiry|date('Y-m-d') : '' }}"
                           class="block w-full md:w-64 border-gray-300 rounded-md shadow-sm focus:ring-club-orange focus:border-club-orange sm:text-sm">
                    <p class="mt-1 text-xs text-gray-500">
                        La licence FFESSM est g√©n√©ralement valide pour la saison (31 ao√ªt)
                    </p>
                </div>

                <div class="flex items-center justify-between pt-4">
                    <div class="text-sm text-gray-500">
                        <p><strong>Informations importantes :</strong></p>
                        <ul class="mt-1 list-disc list-inside space-y-1">
                            <li>La licence doit √™tre en cours de validit√©</li>
                            <li>Visible uniquement par les Directeurs de Plong√©e</li>
                            <li>Vous serez notifi√© 30 jours avant l'expiration</li>
                        </ul>
                    </div>

                    <button type="submit"
                            class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-club-orange hover:bg-club-orange-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-club-orange">
                        <svg class="-ml-1 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        Enregistrer la licence
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notifications Push -->
    <div class="bg-white shadow-sm rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">
                üîî Notifications push
            </h2>
        </div>
        <div class="px-6 py-6">
            <div id="push-notifications-section">
                <!-- Status des notifications -->
                <div id="push-status" class="mb-6">
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div>
                            <h3 class="text-sm font-medium text-gray-900">Statut</h3>
                            <p id="push-status-text" class="text-sm text-gray-500 mt-1">V√©rification...</p>
                        </div>
                        <button id="toggle-push"
                                class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                            <span id="toggle-push-text">Charger...</span>
                        </button>
                    </div>
                </div>

                <!-- Pr√©f√©rences -->
                <div id="push-preferences" class="hidden space-y-4">
                    <div class="border-t border-gray-200 pt-4">
                        <h3 class="text-sm font-medium text-gray-900 mb-3">Pr√©f√©rences de notifications</h3>
                        <div class="space-y-3">
                            <label class="flex items-start">
                                <input type="checkbox" id="pref-registration" class="push-preference mt-1 mr-3 h-4 w-4 text-club-orange focus:ring-club-orange border-gray-300 rounded">
                                <span class="text-sm text-gray-700">
                                    <strong>Nouvelles inscriptions</strong><br>
                                    <span class="text-xs text-gray-500">Notification quand un participant s'inscrit (DP uniquement)</span>
                                </span>
                            </label>
                            <label class="flex items-start">
                                <input type="checkbox" id="pref-cancellation" class="push-preference mt-1 mr-3 h-4 w-4 text-club-orange focus:ring-club-orange border-gray-300 rounded">
                                <span class="text-sm text-gray-700">
                                    <strong>D√©sinscriptions</strong><br>
                                    <span class="text-xs text-gray-500">Notification quand un participant se d√©sinscrit (DP uniquement)</span>
                                </span>
                            </label>
                            <label class="flex items-start">
                                <input type="checkbox" id="pref-waiting-list" class="push-preference mt-1 mr-3 h-4 w-4 text-club-orange focus:ring-club-orange border-gray-300 rounded">
                                <span class="text-sm text-gray-700">
                                    <strong>Place lib√©r√©e</strong><br>
                                    <span class="text-xs text-gray-500">Notification quand une place se lib√®re en liste d'attente</span>
                                </span>
                            </label>
                            <label class="flex items-start">
                                <input type="checkbox" id="pref-new-event" class="push-preference mt-1 mr-3 h-4 w-4 text-club-orange focus:ring-club-orange border-gray-300 rounded">
                                <span class="text-sm text-gray-700">
                                    <strong>Nouvelles plong√©es</strong><br>
                                    <span class="text-xs text-gray-500">Notification quand une plong√©e est cr√©√©e et que votre niveau permet d'y participer</span>
                                </span>
                            </label>
                            <label class="flex items-start">
                                <input type="checkbox" id="pref-as-dp" class="push-preference mt-1 mr-3 h-4 w-4 text-club-orange focus:ring-club-orange border-gray-300 rounded">
                                <span class="text-sm text-gray-700">
                                    <strong>Notifications DP</strong><br>
                                    <span class="text-xs text-gray-500">Toutes les notifications en tant que Directeur de Plong√©e</span>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Info -->
                <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-700">
                                Les notifications push vous permettent de recevoir des alertes en temps r√©el m√™me quand le site n'est pas ouvert.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Attendre que window.pushManager soit initialis√©
        function waitForPushManager() {
            return new Promise((resolve) => {
                if (window.pushManager) {
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (window.pushManager) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);

                    // Timeout apr√®s 5 secondes
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        resolve();
                    }, 5000);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const statusText = document.getElementById('push-status-text');
            const toggleButton = document.getElementById('toggle-push');
            const toggleButtonText = document.getElementById('toggle-push-text');
            const preferencesSection = document.getElementById('push-preferences');

            try {
                // V√©rifier le support des notifications
                if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                    statusText.textContent = '‚ùå Notifications non support√©es par votre navigateur';
                    toggleButton.style.display = 'none';
                    return;
                }

                // Attendre que pushManager soit pr√™t
                statusText.textContent = 'Initialisation...';
                await waitForPushManager();

                if (!window.pushManager) {
                    statusText.textContent = '‚ö†Ô∏è Service non disponible';
                    toggleButtonText.textContent = 'R√©essayer';
                    toggleButton.addEventListener('click', () => location.reload());
                    return;
                }

                async function updateStatus() {
                    try {
                        const isSubscribed = await window.pushManager.isSubscribed();
                        if (isSubscribed) {
                            statusText.textContent = '‚úÖ Notifications activ√©es';
                            statusText.className = 'text-sm text-green-600 mt-1 font-medium';
                            toggleButtonText.textContent = 'D√©sactiver';
                            toggleButton.className = 'px-4 py-2 border border-red-300 rounded-md shadow-sm text-sm font-medium text-red-700 bg-white hover:bg-red-50';
                            preferencesSection.classList.remove('hidden');
                            await loadPreferences();
                        } else {
                            statusText.textContent = '‚ùå Notifications d√©sactiv√©es';
                            statusText.className = 'text-sm text-gray-600 mt-1';
                            toggleButtonText.textContent = 'Activer';
                            toggleButton.className = 'px-4 py-2 border border-green-300 rounded-md shadow-sm text-sm font-medium text-green-700 bg-white hover:bg-green-50';
                            preferencesSection.classList.add('hidden');
                        }
                    } catch (error) {
                        console.error('Error updating status:', error);
                        statusText.textContent = '‚ö†Ô∏è Erreur de v√©rification';
                        statusText.className = 'text-sm text-red-600 mt-1';
                    }
                }

            async function loadPreferences() {
                try {
                    const response = await fetch('/api/push/subscriptions');
                    const subscriptions = await response.json();
                    if (subscriptions.length > 0) {
                        const prefs = subscriptions[0].preferences;
                        document.getElementById('pref-registration').checked = prefs.notifyEventRegistration;
                        document.getElementById('pref-cancellation').checked = prefs.notifyEventCancellation;
                        document.getElementById('pref-waiting-list').checked = prefs.notifyWaitingListPromotion;
                        document.getElementById('pref-new-event').checked = prefs.notifyNewEvent;
                        document.getElementById('pref-as-dp').checked = prefs.notifyAsDP;
                    }
                } catch (error) {
                    console.error('Error loading preferences:', error);
                }
            }

            toggleButton.addEventListener('click', async function() {
                toggleButton.disabled = true;
                const isSubscribed = await window.pushManager.isSubscribed();
                if (isSubscribed) {
                    await window.pushManager.unsubscribe();
                } else {
                    const result = await window.pushManager.subscribe();
                    if (result.reason === 'permission_denied') {
                        alert('Autorisez les notifications dans votre navigateur pour activer cette fonctionnalit√©.');
                    }
                }
                await updateStatus();
                toggleButton.disabled = false;
            });

                document.querySelectorAll('.push-preference').forEach(checkbox => {
                    checkbox.addEventListener('change', async function() {
                        const preferences = {
                            notifyEventRegistration: document.getElementById('pref-registration').checked,
                            notifyEventCancellation: document.getElementById('pref-cancellation').checked,
                            notifyWaitingListPromotion: document.getElementById('pref-waiting-list').checked,
                            notifyNewEvent: document.getElementById('pref-new-event').checked,
                            notifyAsDP: document.getElementById('pref-as-dp').checked
                        };
                        const result = await window.pushManager.updatePreferences(preferences);
                        if (result.success) {
                            const originalText = statusText.textContent;
                            statusText.textContent = '‚úÖ Pr√©f√©rences enregistr√©es !';
                            setTimeout(() => { statusText.textContent = originalText; }, 2000);
                        }
                    });
                });

                await updateStatus();
            } catch (error) {
                console.error('Push notification initialization error:', error);
                statusText.textContent = '‚ö†Ô∏è Erreur d\'initialisation';
                statusText.className = 'text-sm text-red-600 mt-1';
                toggleButtonText.textContent = 'R√©essayer';
                toggleButton.addEventListener('click', () => location.reload());
            }
        });
    </script>
</div>
{% endblock %}