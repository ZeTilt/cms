{% extends 'plongee_base.html.twig' %}

{% block title %}Mon Profil{% endblock %}

{% block body %}
<div class="profile-page">
    <!-- En-t√™te -->
    <div class="profile-card">
        <div class="profile-card-header">
            <div class="profile-header">
                <div class="profile-header-left">
                    {% if user.avatarFile %}
                        <img src="{{ asset('uploads/avatars/' ~ user.avatarFile) }}"
                             alt="Avatar {{ user.fullName }}"
                             class="profile-avatar">
                    {% else %}
                        <div class="profile-avatar-placeholder">
                            <span>{{ user.fullName|slice(0, 1)|upper }}</span>
                        </div>
                    {% endif %}
                    <div class="profile-user-info">
                        <h1 class="profile-user-name">{{ user.fullName }}</h1>
                        <p class="profile-user-email">{{ user.email }}</p>
                    </div>
                </div>

                <!-- Upload avatar -->
                <div class="profile-avatar-upload">
                    <form method="POST" action="{{ path('user_profile_upload_avatar') }}" enctype="multipart/form-data" id="avatar-form">
                        <input type="hidden" name="_token" value="{{ csrf_token('upload_avatar') }}">
                        <label for="avatar-input" class="profile-avatar-label">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            Changer l'avatar
                        </label>
                        <input type="file" id="avatar-input" name="avatar" accept="image/*" class="hidden" onchange="document.getElementById('avatar-form').submit()">
                    </form>
                    {% if user.avatarFile %}
                        <form method="POST" action="{{ path('user_profile_delete_avatar') }}">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete_avatar') }}">
                            <button type="submit" class="profile-delete-avatar" onclick="return confirm('Supprimer votre avatar ?')">
                                Supprimer l'avatar
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Informations de base -->
        <div class="profile-card-body">
            <div class="profile-info-grid">
                <div class="profile-info-item">
                    <dt>Statut</dt>
                    <dd>
                        {% if user.status == 'approved' %}
                            <span class="profile-badge profile-badge-green">‚úì Approuv√©</span>
                        {% elseif user.status == 'pending' %}
                            <span class="profile-badge profile-badge-yellow">‚è≥ En attente</span>
                        {% else %}
                            <span class="profile-badge profile-badge-red">‚ùå {{ user.status|title }}</span>
                        {% endif %}
                    </dd>
                </div>
                <div class="profile-info-item">
                    <dt>Membre depuis</dt>
                    <dd>{{ user.createdAt|date('d/m/Y') }}</dd>
                </div>
                <div class="profile-info-item">
                    <dt>Derni√®re mise √† jour</dt>
                    <dd>
                        {% if user.updatedAt %}
                            {{ user.updatedAt|date('d/m/Y') }}
                        {% else %}
                            Non modifi√©
                        {% endif %}
                    </dd>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerte compte en attente -->
    {% if user.status == 'pending' %}
    <div class="profile-alert profile-alert-warning">
        <div class="profile-alert-inner">
            <div class="profile-alert-icon">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
            </div>
            <div class="profile-alert-content">
                <h3 class="profile-alert-title">Compte en attente de validation</h3>
                <div class="profile-alert-text">
                    <p>Votre compte est en attente d'approbation par un administrateur du club. Vous pourrez vous inscrire aux plong√©es d√®s que votre compte sera valid√©.</p>
                    <p class="profile-alert-date">Membre depuis le {{ user.createdAt|date('d/m/Y √† H:i') }}</p>
                    <form method="POST" action="{{ path('user_profile_remind_admins') }}" style="display: inline-block;">
                        <input type="hidden" name="_token" value="{{ csrf_token('remind_admins') }}">
                        <button type="submit" class="profile-btn profile-btn-warning">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            Relancer les administrateurs
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Niveaux et Activit√©s -->
    <div class="profile-card">
        <div class="profile-card-header">
            <h2 class="profile-card-title">üèä Activit√©s et Niveaux</h2>
            <p class="profile-card-subtitle">D√©finissez vos activit√©s et niveaux pour acc√©der aux √©v√©nements correspondants.</p>
        </div>

        <div class="profile-card-body">
            <form method="POST" action="{{ path('user_profile_activities') }}" class="profile-form">
                <input type="hidden" name="_token" value="{{ csrf_token('profile_activities') }}">

                <!-- Activit√©s pratiqu√©es -->
                <div class="profile-form-group">
                    <label>Mes activit√©s</label>
                    <div class="profile-checkbox-group">
                        <label class="profile-checkbox-label">
                            <input type="checkbox" name="is_diver" value="1" {{ user.isDiver ? 'checked' : '' }}
                                   onchange="document.getElementById('diving_level_section').style.display = this.checked ? 'block' : 'none'"
                                   class="profile-checkbox">
                            <span class="profile-checkbox-text">ü§ø Je pratique la plong√©e bouteille</span>
                        </label>
                        <label class="profile-checkbox-label">
                            <input type="checkbox" name="is_freediver" value="1" {{ user.isFreediver ? 'checked' : '' }}
                                   onchange="document.getElementById('freediving_level_section').style.display = this.checked ? 'block' : 'none'"
                                   class="profile-checkbox">
                            <span class="profile-checkbox-text">üåä Je pratique l'apn√©e</span>
                        </label>
                        <label class="profile-checkbox-label">
                            <input type="checkbox" name="is_pilot" value="1" {{ user.isPilot ? 'checked' : '' }}
                                   class="profile-checkbox">
                            <span class="profile-checkbox-text">‚õµ Je suis pilote de bateau</span>
                        </label>
                    </div>
                </div>

                <!-- Niveau de plong√©e -->
                <div id="diving_level_section" style="display: {{ user.isDiver ? 'block' : 'none' }}">
                    <div class="profile-form-group">
                        <label for="diving_level_id">Niveau de plong√©e bouteille</label>
                        <select name="diving_level_id" id="diving_level_id" class="profile-select profile-input-medium">
                            <option value="">-- S√©lectionner mon niveau --</option>
                            {% for level in divingLevels %}
                                <option value="{{ level.id }}"
                                        {{ user.highestDivingLevel and user.highestDivingLevel.id == level.id ? 'selected' : '' }}>
                                    {{ level.name }}
                                    {% if level.description %} - {{ level.description }}{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Niveau d'apn√©e -->
                <div id="freediving_level_section" style="display: {{ user.isFreediver ? 'block' : 'none' }}">
                    <div class="profile-form-group">
                        <label for="freediving_level_id">Niveau d'apn√©e</label>
                        <select name="freediving_level_id" id="freediving_level_id" class="profile-select profile-input-medium">
                            <option value="">-- S√©lectionner mon niveau --</option>
                            {% for level in freedivingLevels %}
                                <option value="{{ level.id }}"
                                        {{ user.highestFreedivingLevel and user.highestFreedivingLevel.id == level.id ? 'selected' : '' }}>
                                    {{ level.name }}
                                    {% if level.description %} - {{ level.description }}{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="profile-form-footer">
                    <button type="submit" class="profile-btn profile-btn-primary">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Informations personnelles -->
    <div class="profile-card">
        <div class="profile-card-header">
            <h2 class="profile-card-title">üë§ Informations Personnelles</h2>
            <p class="profile-card-subtitle">Ces informations sont visibles uniquement par les Directeurs de Plong√©e.</p>
        </div>

        <div class="profile-card-body">
            <form method="POST" action="{{ path('user_profile_personal_info') }}" class="profile-form">
                <input type="hidden" name="_token" value="{{ csrf_token('personal_info') }}">

                <!-- T√©l√©phone mobile -->
                <div class="profile-form-group">
                    <label for="phone_number">üì± Num√©ro de t√©l√©phone mobile</label>
                    <input type="tel"
                           name="phone_number"
                           id="phone_number"
                           value="{{ user.phoneNumber ?? '' }}"
                           placeholder="Ex: 06 12 34 56 78"
                           class="profile-input profile-input-medium">
                    <p class="profile-hint">Pour vous contacter en cas d'urgence</p>
                </div>

                <!-- Date de naissance -->
                <div class="profile-form-group">
                    <label for="date_of_birth">üéÇ Date de naissance</label>
                    <input type="date"
                           name="date_of_birth"
                           id="date_of_birth"
                           value="{{ user.dateOfBirth ? user.dateOfBirth|date('Y-m-d') : '' }}"
                           class="profile-input profile-input-small">
                    <p class="profile-hint">Utile pour les assurances et validit√© des certificats</p>
                </div>

                <!-- Adresse postale -->
                <div class="profile-form-group">
                    <label for="address">üè† Adresse postale</label>
                    <textarea name="address"
                              id="address"
                              rows="3"
                              placeholder="Num√©ro et rue&#10;Code postal et ville"
                              class="profile-textarea">{{ user.address ?? '' }}</textarea>
                    <p class="profile-hint">Pour l'envoi de documents administratifs</p>
                </div>

                <div class="profile-form-footer profile-form-footer-between">
                    <div class="profile-form-info">
                        <p><strong>üîí Confidentialit√© :</strong></p>
                        <p>Ces informations ne sont visibles que par les DP et ne sont jamais partag√©es.</p>
                    </div>

                    <button type="submit" class="profile-btn profile-btn-primary">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Certificat m√©dical -->
    <div class="profile-card">
        <div class="profile-card-header">
            <h2 class="profile-card-title">üè• Certificat M√©dical</h2>
            <p class="profile-card-subtitle">Ajoutez votre certificat m√©dical pour permettre aux DP de v√©rifier sa validit√©.</p>
        </div>

        <div class="profile-card-body">
            <form method="POST" action="{{ path('user_profile_medical_certificate') }}" enctype="multipart/form-data" class="profile-form">
                <input type="hidden" name="_token" value="{{ csrf_token('medical_certificate') }}">

                <!-- Statut actuel -->
                {% if user.medicalCertificateFile %}
                    <div class="profile-status-box {{ user.isMedicalCertificateValid() ? 'profile-status-box-green' : 'profile-status-box-red' }}">
                        <div class="profile-status-icon {{ user.isMedicalCertificateValid() ? 'profile-status-icon-green' : 'profile-status-icon-red' }}">
                            {% if user.isMedicalCertificateValid() %}
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                            {% else %}
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                            {% endif %}
                        </div>
                        <div class="profile-status-content">
                            <h3 class="profile-status-title {{ user.isMedicalCertificateValid() ? 'profile-status-title-green' : 'profile-status-title-red' }}">
                                {% if user.isMedicalCertificateValid() %}
                                    ‚úì Certificat m√©dical valide
                                {% else %}
                                    ‚ö†Ô∏è Certificat m√©dical expir√©
                                {% endif %}
                            </h3>
                            <div class="profile-status-text {{ user.isMedicalCertificateValid() ? 'profile-status-text-green' : 'profile-status-text-red' }}">
                                <p>Date d'expiration : {{ user.medicalCertificateExpiry|date('d/m/Y') }}</p>
                                <p><a href="{{ asset('uploads/medical_certificates/' ~ user.medicalCertificateFile) }}" target="_blank">Voir le certificat</a></p>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="profile-status-box profile-status-box-yellow">
                        <div class="profile-status-icon profile-status-icon-yellow">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="profile-status-content">
                            <h3 class="profile-status-title profile-status-title-yellow">Aucun certificat m√©dical</h3>
                            <p class="profile-status-text profile-status-text-yellow">Vous devez fournir un certificat m√©dical valide pour participer aux plong√©es.</p>
                        </div>
                    </div>
                {% endif %}

                <!-- Upload du certificat -->
                <div class="profile-form-group">
                    <label for="medical_certificate_file">{{ user.medicalCertificateFile ? 'Remplacer le certificat' : 'Fichier du certificat' }}</label>
                    <input type="file"
                           name="medical_certificate_file"
                           id="medical_certificate_file"
                           accept=".pdf,.jpg,.jpeg,.png"
                           class="profile-file-input">
                    <p class="profile-hint">Formats accept√©s : PDF, JPG, PNG (max 5 Mo)</p>
                </div>

                <!-- Date d'expiration -->
                <div class="profile-form-group">
                    <label for="medical_certificate_expiry">Date d'expiration *</label>
                    <input type="date"
                           name="medical_certificate_expiry"
                           id="medical_certificate_expiry"
                           value="{{ user.medicalCertificateExpiry ? user.medicalCertificateExpiry|date('Y-m-d') : '' }}"
                           required
                           class="profile-input profile-input-small">
                    <p class="profile-hint">Un certificat m√©dical est g√©n√©ralement valide 1 an</p>
                </div>

                <div class="profile-form-footer profile-form-footer-between">
                    <div class="profile-form-info">
                        <p><strong>Informations importantes :</strong></p>
                        <ul>
                            <li>Le certificat doit √™tre en cours de validit√©</li>
                            <li>Visible uniquement par les Directeurs de Plong√©e</li>
                            <li>Vous serez notifi√© 30 jours avant l'expiration</li>
                        </ul>
                    </div>

                    <button type="submit" class="profile-btn profile-btn-primary">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        Enregistrer le certificat
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Licence FFESSM -->
    <div class="profile-card">
        <div class="profile-card-header">
            <h2 class="profile-card-title">üé´ Licence FFESSM</h2>
            <p class="profile-card-subtitle">Ajoutez votre justificatif de licence pour permettre aux DP de v√©rifier sa validit√©.</p>
        </div>

        <div class="profile-card-body">
            <form method="POST" action="{{ path('user_profile_licence') }}" enctype="multipart/form-data" class="profile-form">
                <input type="hidden" name="_token" value="{{ csrf_token('licence') }}">

                <!-- Statut actuel -->
                {% if user.licenceFile %}
                    <div class="profile-status-box {{ user.isLicenceValid() ? 'profile-status-box-green' : 'profile-status-box-red' }}">
                        <div class="profile-status-icon {{ user.isLicenceValid() ? 'profile-status-icon-green' : 'profile-status-icon-red' }}">
                            {% if user.isLicenceValid() %}
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                            {% else %}
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                            {% endif %}
                        </div>
                        <div class="profile-status-content">
                            <h3 class="profile-status-title {{ user.isLicenceValid() ? 'profile-status-title-green' : 'profile-status-title-red' }}">
                                {% if user.isLicenceValid() %}
                                    ‚úì Licence valide
                                {% else %}
                                    ‚ö†Ô∏è Licence expir√©e
                                {% endif %}
                            </h3>
                            <div class="profile-status-text {{ user.isLicenceValid() ? 'profile-status-text-green' : 'profile-status-text-red' }}">
                                {% if user.licenceNumber %}
                                    <p>Num√©ro : {{ user.licenceNumber }}</p>
                                {% endif %}
                                <p>Date d'expiration : {{ user.licenceExpiry|date('d/m/Y') }}</p>
                                <p><a href="{{ asset('uploads/licences/' ~ user.licenceFile) }}" target="_blank">Voir le justificatif</a></p>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="profile-status-box profile-status-box-yellow">
                        <div class="profile-status-icon profile-status-icon-yellow">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="profile-status-content">
                            <h3 class="profile-status-title profile-status-title-yellow">Aucun justificatif de licence</h3>
                            <p class="profile-status-text profile-status-text-yellow">Vous devez fournir un justificatif de licence valide pour participer aux plong√©es.</p>
                        </div>
                    </div>
                {% endif %}

                <!-- Num√©ro de licence -->
                <div class="profile-form-group">
                    <label for="licence_number">Num√©ro de licence</label>
                    <input type="text"
                           name="licence_number"
                           id="licence_number"
                           value="{{ user.licenceNumber ?? '' }}"
                           placeholder="Ex: 123456789"
                           class="profile-input profile-input-medium">
                    <p class="profile-hint">Num√©ro visible sur votre carte de licence</p>
                </div>

                <!-- Upload du justificatif -->
                <div class="profile-form-group">
                    <label for="licence_file">{{ user.licenceFile ? 'Remplacer le justificatif' : 'Fichier du justificatif' }}</label>
                    <input type="file"
                           name="licence_file"
                           id="licence_file"
                           accept=".pdf,.jpg,.jpeg,.png"
                           class="profile-file-input">
                    <p class="profile-hint">Formats accept√©s : PDF, JPG, PNG (max 5 Mo)</p>
                </div>

                <!-- Date d'expiration -->
                <div class="profile-form-group">
                    <label for="licence_expiry">Date d'expiration (optionnelle)</label>
                    <input type="date"
                           name="licence_expiry"
                           id="licence_expiry"
                           value="{{ user.licenceExpiry ? user.licenceExpiry|date('Y-m-d') : '' }}"
                           class="profile-input profile-input-small">
                    <p class="profile-hint">La licence FFESSM est g√©n√©ralement valide pour la saison (31 ao√ªt)</p>
                </div>

                <div class="profile-form-footer profile-form-footer-between">
                    <div class="profile-form-info">
                        <p><strong>Informations importantes :</strong></p>
                        <ul>
                            <li>La licence doit √™tre en cours de validit√©</li>
                            <li>Visible uniquement par les Directeurs de Plong√©e</li>
                            <li>Vous serez notifi√© 30 jours avant l'expiration</li>
                        </ul>
                    </div>

                    <button type="submit" class="profile-btn profile-btn-primary">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        Enregistrer la licence
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notifications Push -->
    <div class="profile-card">
        <div class="profile-card-header">
            <h2 class="profile-card-title">üîî Notifications push</h2>
        </div>
        <div class="profile-card-body">
            <div id="push-notifications-section">
                <!-- Status des notifications -->
                <div id="push-status" class="profile-push-status">
                    <div>
                        <h3>Statut</h3>
                        <p id="push-status-text">V√©rification...</p>
                    </div>
                    <button id="toggle-push" class="profile-btn profile-btn-outline">
                        <span id="toggle-push-text">Charger...</span>
                    </button>
                </div>

                <!-- Pr√©f√©rences -->
                <div id="push-preferences" class="profile-push-preferences hidden">
                    <h3>Pr√©f√©rences de notifications</h3>
                    <div>
                        <label class="profile-push-option">
                            <input type="checkbox" id="pref-registration" class="push-preference profile-checkbox">
                            <span class="profile-push-option-text">
                                <strong>Nouvelles inscriptions</strong>
                                <span>Notification quand un participant s'inscrit (DP uniquement)</span>
                            </span>
                        </label>
                        <label class="profile-push-option">
                            <input type="checkbox" id="pref-cancellation" class="push-preference profile-checkbox">
                            <span class="profile-push-option-text">
                                <strong>D√©sinscriptions</strong>
                                <span>Notification quand un participant se d√©sinscrit (DP uniquement)</span>
                            </span>
                        </label>
                        <label class="profile-push-option">
                            <input type="checkbox" id="pref-waiting-list" class="push-preference profile-checkbox">
                            <span class="profile-push-option-text">
                                <strong>Place lib√©r√©e</strong>
                                <span>Notification quand une place se lib√®re en liste d'attente</span>
                            </span>
                        </label>
                        <label class="profile-push-option">
                            <input type="checkbox" id="pref-new-event" class="push-preference profile-checkbox">
                            <span class="profile-push-option-text">
                                <strong>Nouvelles plong√©es</strong>
                                <span>Notification quand une plong√©e est cr√©√©e et que votre niveau permet d'y participer</span>
                            </span>
                        </label>
                        <label class="profile-push-option">
                            <input type="checkbox" id="pref-as-dp" class="push-preference profile-checkbox">
                            <span class="profile-push-option-text">
                                <strong>Notifications DP</strong>
                                <span>Toutes les notifications en tant que Directeur de Plong√©e</span>
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Info -->
                <div class="profile-info-box profile-info-box-blue">
                    <div class="profile-info-box-inner">
                        <div class="profile-info-box-icon">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <p class="profile-info-box-text">
                            Les notifications push vous permettent de recevoir des alertes en temps r√©el m√™me quand le site n'est pas ouvert.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Attendre que window.pushManager soit initialis√©
        function waitForPushManager() {
            return new Promise((resolve) => {
                if (window.pushManager) {
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (window.pushManager) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);

                    // Timeout apr√®s 5 secondes
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        resolve();
                    }, 5000);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const statusText = document.getElementById('push-status-text');
            const toggleButton = document.getElementById('toggle-push');
            const toggleButtonText = document.getElementById('toggle-push-text');
            const preferencesSection = document.getElementById('push-preferences');

            try {
                // V√©rifier le support des notifications
                if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                    statusText.textContent = '‚ùå Notifications non support√©es par votre navigateur';
                    toggleButton.style.display = 'none';
                    return;
                }

                // Attendre que pushManager soit pr√™t
                statusText.textContent = 'Initialisation...';
                await waitForPushManager();

                if (!window.pushManager) {
                    statusText.textContent = '‚ö†Ô∏è Service non disponible';
                    toggleButtonText.textContent = 'R√©essayer';
                    toggleButton.addEventListener('click', () => location.reload());
                    return;
                }

                async function updateStatus() {
                    try {
                        const isSubscribed = await window.pushManager.isSubscribed();
                        if (isSubscribed) {
                            statusText.textContent = '‚úÖ Notifications activ√©es';
                            statusText.style.color = '#16a34a';
                            statusText.style.fontWeight = '500';
                            toggleButtonText.textContent = 'D√©sactiver';
                            toggleButton.className = 'profile-btn profile-btn-outline profile-btn-outline-red';
                            preferencesSection.classList.remove('hidden');
                            await loadPreferences();
                        } else {
                            statusText.textContent = '‚ùå Notifications d√©sactiv√©es';
                            statusText.style.color = '#6b7280';
                            toggleButtonText.textContent = 'Activer';
                            toggleButton.className = 'profile-btn profile-btn-outline profile-btn-outline-green';
                            preferencesSection.classList.add('hidden');
                        }
                    } catch (error) {
                        console.error('Error updating status:', error);
                        statusText.textContent = '‚ö†Ô∏è Erreur de v√©rification';
                        statusText.style.color = '#dc2626';
                    }
                }

            async function loadPreferences() {
                try {
                    const response = await fetch('/api/push/subscriptions');
                    const subscriptions = await response.json();
                    if (subscriptions.length > 0) {
                        const prefs = subscriptions[0].preferences;
                        document.getElementById('pref-registration').checked = prefs.notifyEventRegistration;
                        document.getElementById('pref-cancellation').checked = prefs.notifyEventCancellation;
                        document.getElementById('pref-waiting-list').checked = prefs.notifyWaitingListPromotion;
                        document.getElementById('pref-new-event').checked = prefs.notifyNewEvent;
                        document.getElementById('pref-as-dp').checked = prefs.notifyAsDP;
                    }
                } catch (error) {
                    console.error('Error loading preferences:', error);
                }
            }

            toggleButton.addEventListener('click', async function() {
                toggleButton.disabled = true;
                const isSubscribed = await window.pushManager.isSubscribed();
                if (isSubscribed) {
                    await window.pushManager.unsubscribe();
                } else {
                    const result = await window.pushManager.subscribe();
                    if (result.reason === 'permission_denied') {
                        alert('Autorisez les notifications dans votre navigateur pour activer cette fonctionnalit√©.');
                    }
                }
                await updateStatus();
                toggleButton.disabled = false;
            });

                document.querySelectorAll('.push-preference').forEach(checkbox => {
                    checkbox.addEventListener('change', async function() {
                        const preferences = {
                            notifyEventRegistration: document.getElementById('pref-registration').checked,
                            notifyEventCancellation: document.getElementById('pref-cancellation').checked,
                            notifyWaitingListPromotion: document.getElementById('pref-waiting-list').checked,
                            notifyNewEvent: document.getElementById('pref-new-event').checked,
                            notifyAsDP: document.getElementById('pref-as-dp').checked
                        };
                        const result = await window.pushManager.updatePreferences(preferences);
                        if (result.success) {
                            const originalText = statusText.textContent;
                            statusText.textContent = '‚úÖ Pr√©f√©rences enregistr√©es !';
                            setTimeout(() => { statusText.textContent = originalText; }, 2000);
                        }
                    });
                });

                await updateStatus();
            } catch (error) {
                console.error('Push notification initialization error:', error);
                statusText.textContent = '‚ö†Ô∏è Erreur d\'initialisation';
                statusText.style.color = '#dc2626';
                toggleButtonText.textContent = 'R√©essayer';
                toggleButton.addEventListener('click', () => location.reload());
            }
        });
    </script>
</div>
{% endblock %}
